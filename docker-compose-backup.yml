services:
  backup:
    build: ./borgmatic
    restart: always
    environment:
      - TZ=Europe/Berlin
      - BORG_PASSPHRASE=${BACKUP_PASSWORD}
      - BACKUP_CRON=0 2 * * *
      # S3 sync credentials for rclone
      - RCLONE_CONFIG_S3_TYPE=s3
      - RCLONE_CONFIG_S3_PROVIDER=AWS
      - RCLONE_CONFIG_S3_ACCESS_KEY_ID=${BACKUP_AWS_ACCESS_KEY_ID}
      - RCLONE_CONFIG_S3_SECRET_ACCESS_KEY=${BACKUP_AWS_SECRET_ACCESS_KEY}
      - RCLONE_CONFIG_S3_REGION=eu-central-1
    volumes:
      # Borgmatic configuration
      - ./borgmatic/config.yaml:/etc/borgmatic.d/config.yaml:ro
      - ./borgmatic/crontab.txt:/etc/borgmatic.d/crontab.txt:ro
      # Source volumes to backup (read-only)
      - db:/mnt/source/db:ro
      - nextcloud:/mnt/source/nextcloud:ro
      # Local Borg repository
      - borg-repo:/mnt/borg-repository
      # Borg cache and config (persistent)
      - borg-cache:/root/.cache/borg
      - borg-config:/root/.config/borg
      # Docker socket for stopping containers during backup
      - /var/run/docker.sock:/var/run/docker.sock:ro

volumes:
  borg-repo:
  borg-cache:
  borg-config:
